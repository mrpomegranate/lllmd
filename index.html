<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediMind RAG - Clinical Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* refined typography for medical reports */
        .prose { max-width: none; font-size: 0.95rem; line-height: 1.7; color: #334155; }
        .prose h1 { font-size: 1.5rem; font-weight: 700; color: #0f172a; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0; }
        .prose h2 { font-size: 1.25rem; font-weight: 600; color: #1e40af; margin-top: 1.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .prose h3 { font-size: 1.1rem; font-weight: 600; color: #475569; margin-top: 1.25rem; }
        .prose ul { list-style-type: disc; padding-left: 1.25rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose strong { color: #0f172a; font-weight: 600; }
        .prose p { margin-bottom: 0.75rem; }

        /* wrapping fix */
        .prose pre {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #e2e8f0;
            font-size: 0.875rem;
            color: #334155;
        }

        /* custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-md border-b border-slate-200 z-40">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white shadow-sm">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                </div>
                <span class="text-lg font-bold text-slate-900 tracking-tight">MediMind<span class="text-blue-600">RAG</span></span>
            </div>
            <div id="server-status" class="text-xs font-medium px-2.5 py-1 rounded-full bg-slate-100 text-slate-500 flex items-center gap-1.5 transition-colors">
                <span class="w-2 h-2 rounded-full bg-slate-400"></span> Connecting...
            </div>
        </div>
    </nav>

    <!-- Main Application Area -->
    <main id="app-root" class="max-w-7xl mx-auto pt-24 pb-12 px-4 md:px-8 min-h-screen">
        <!-- Dynamic content injected here -->
    </main>

    <script>
        const API_URL = "http://127.0.0.1:8000";

        const state = {
            step: 1,
            cases: [],
            selectedCase: null,
            previewData: [],
            summaries: null,
            diagnosis: null,
            isLoading: false,
            loadingMsg: "Processing..."
        };

        // --- API Logic ---
        async function checkServer() {
            try {
                await fetch(API_URL);
                const el = document.getElementById('server-status');
                el.className = "text-xs font-medium px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 flex items-center gap-1.5";
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> System Online';
            } catch (e) {
                const el = document.getElementById('server-status');
                el.className = "text-xs font-medium px-2.5 py-1 rounded-full bg-red-50 text-red-700 border border-red-100 flex items-center gap-1.5";
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Offline';
            }
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            try {
                setLoading(true, "Securely Uploading & Parsing Data...");
                const res = await fetch(`${API_URL}/upload`, { method: 'POST', body: formData });
                if (!res.ok) throw new Error("Upload failed");

                const casesRes = await fetch(`${API_URL}/cases`);
                const casesData = await casesRes.json();
                state.cases = casesData.cases;
                state.selectedCase = state.cases[0];
                await fetchPreview(state.selectedCase);
                state.step = 2;
            } catch (e) { alert(e.message); } finally { setLoading(false); updateView(); }
        }

        async function fetchPreview(caseNum) {
            const res = await fetch(`${API_URL}/cases/${caseNum}?limit=1000`);
            const data = await res.json();
            state.previewData = data.data;
            state.selectedCase = caseNum;
            updateView();
        }

        async function runSummarization() {
            state.step = 3;
            setLoading(true, "Generating Multi-Model Summaries...");
            updateView();
            try {
                const res = await fetch(`${API_URL}/summarize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ case_num: state.selectedCase, patient_limit: 1000 })
                });
                if (!res.ok) throw new Error("Summarization failed");
                state.summaries = await res.json();
                state.step = 4;
            } catch (e) { alert(e.message); state.step = 2; } finally { setLoading(false); updateView(); }
        }

        async function runDiagnosis() {
            state.step = 5;
            setLoading(true, "Agent is researching diagnosis & guidelines...");
            updateView();
            try {
                const res = await fetch(`${API_URL}/diagnose`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clinical_summary: state.summaries.summary_final })
                });
                if (!res.ok) throw new Error("Diagnosis failed");
                const data = await res.json();
                state.diagnosis = data.diagnosis_report;
                state.step = 6;
            } catch (e) { alert(e.message); state.step = 4; } finally { setLoading(false); updateView(); }
        }

        // --- UI Components ---

        function setLoading(active, msg) {
            state.isLoading = active;
            state.loadingMsg = msg;
            updateView();
        }

        function renderLoading() {
            return `
                <div class="absolute inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center fade-in rounded-2xl">
                    <div class="relative mb-6">
                        <div class="w-16 h-16 rounded-full border-4 border-slate-100 border-t-blue-600 animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i data-lucide="zap" class="w-6 h-6 text-blue-600 fill-current"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 mb-2">${state.loadingMsg}</h3>
                    <p class="text-slate-500 font-medium">Processing clinical data securely</p>
                </div>
            `;
        }

        function renderUpload() {
            return `
                <div class="max-w-xl mx-auto mt-12 text-center fade-in">
                    <div class="bg-white rounded-2xl border-2 border-dashed border-slate-300 hover:border-blue-500 hover:bg-blue-50/30 transition-all cursor-pointer p-12 group shadow-sm" onclick="document.getElementById('csvInput').click()">
                        <input type="file" id="csvInput" class="hidden" accept=".csv" onchange="handleFileSelect(this)">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                            <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Upload Patient Records</h2>
                        <p class="text-slate-500 mb-8 text-sm">Drag & drop your <code class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-700 font-medium">.csv</code> file here</p>
                        <button class="bg-slate-900 text-white px-6 py-3 rounded-xl font-medium shadow hover:bg-slate-800 transition-colors inline-flex items-center gap-2">
                            <span>Select File</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderReview() {
            const options = state.cases.map(c => `<option value="${c}" ${c===state.selectedCase?'selected':''}>Case ${c}</option>`).join('');
            const rows = state.previewData.map(r => `
                <tr class="border-b border-slate-100 last:border-0 hover:bg-slate-50/80 transition-colors">
                    <td class="py-4 px-5 align-top w-32">
                        <span class="font-mono text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded">${r.pn_num}</span>
                    </td>
                    <td class="py-4 px-5 align-top">
                        <div class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap font-normal">${r.pn_history}</div>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6 fade-in">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-wrap items-center justify-between gap-4 sticky top-20 z-30">
                        <div class="flex items-center gap-4 pl-2">
                            <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center">
                                <i data-lucide="folder-search" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-0.5">Selected Cohort</label>
                                <div class="relative group">
                                    <select onchange="fetchPreview(parseInt(this.value))" class="appearance-none bg-transparent font-bold text-slate-900 pr-8 outline-none cursor-pointer group-hover:text-blue-600 transition-colors">
                                        ${options}
                                    </select>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-4 pr-2">
                            <div class="text-right hidden sm:block">
                                <div class="text-2xl font-bold text-slate-900 leading-none">${state.previewData.length}</div>
                                <div class="text-xs text-slate-500 font-medium">Records</div>
                            </div>
                            <div class="h-8 w-px bg-slate-200 hidden sm:block"></div>
                            <button onclick="runSummarization()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-medium shadow-sm hover:shadow-md transition-all active:scale-95 flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                                <span>Generate Summaries</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto max-h-[calc(100vh-16rem)] overflow-y-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50/80 backdrop-blur sticky top-0 z-20 border-b border-slate-200">
                                    <tr>
                                        <th class="py-3 px-5 text-xs font-semibold text-slate-500 uppercase tracking-wider">Record ID</th>
                                        <th class="py-3 px-5 text-xs font-semibold text-slate-500 uppercase tracking-wider">Clinical Narrative</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">${rows}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSummaryView() {
            return `
                <div class="space-y-8 fade-in">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div>
                            <h2 class="text-xl font-bold text-slate-900">Consensus Summary Generated</h2>
                            <p class="text-sm text-slate-500 mt-1">Review the combined findings from 3 distinct models below.</p>
                        </div>
                        <button onclick="runDiagnosis()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-medium shadow-lg shadow-emerald-100 transition-all flex items-center gap-2 group">
                            <i data-lucide="stethoscope" class="w-5 h-5"></i>
                            <span>Run Diagnostic Agent</span>
                            <i data-lucide="arrow-right" class="w-4 h-4 opacity-60 group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-6 h-[600px]">
                        <!-- Left Column: Source Models -->
                        <div class="flex flex-col gap-6 h-full">
                            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col flex-1 overflow-hidden">
                                <div class="px-5 py-3 border-b border-slate-100 bg-indigo-50/50 flex justify-between items-center">
                                    <span class="text-xs font-bold text-indigo-600 uppercase tracking-wider flex items-center gap-2">
                                        <i data-lucide="cpu" class="w-3 h-3"></i> BioMistral-7B
                                    </span>
                                    <span class="text-[10px] font-medium bg-white px-2 py-0.5 rounded border border-indigo-100 text-indigo-400">Model A</span>
                                </div>
                                <div class="p-5 overflow-y-auto text-xs text-slate-600 font-mono whitespace-pre-wrap bg-slate-50/50 flex-1 border-l-4 border-transparent hover:border-indigo-400 transition-colors">${state.summaries.summary_a}</div>
                            </div>

                            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col flex-1 overflow-hidden">
                                <div class="px-5 py-3 border-b border-slate-100 bg-purple-50/50 flex justify-between items-center">
                                    <span class="text-xs font-bold text-purple-600 uppercase tracking-wider flex items-center gap-2">
                                        <i data-lucide="cpu" class="w-3 h-3"></i> Llama3-Med42-8B
                                    </span>
                                    <span class="text-[10px] font-medium bg-white px-2 py-0.5 rounded border border-purple-100 text-purple-400">Model B</span>
                                </div>
                                <div class="p-5 overflow-y-auto text-xs text-slate-600 font-mono whitespace-pre-wrap bg-slate-50/50 flex-1 border-l-4 border-transparent hover:border-purple-400 transition-colors">${state.summaries.summary_b}</div>
                            </div>
                        </div>

                        <!-- Right Column: Meta Summary -->
                        <div class="bg-slate-900 rounded-2xl border border-slate-800 shadow-xl overflow-hidden flex flex-col h-full">
                            <div class="px-6 py-4 border-b border-slate-800 bg-slate-950 flex items-center gap-3 shrink-0">
                                <div class="p-1.5 bg-emerald-500/20 text-emerald-400 rounded-lg">
                                    <i data-lucide="layers" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-100 text-sm">Meta-Analysis</h3>
                                    <p class="text-xs text-slate-500">Synthesized by Mistral-Instruct-v0.3</p>
                                </div>
                            </div>
                            <div class="p-6 overflow-y-auto flex-1">
                                <div class="text-sm font-mono text-slate-300 whitespace-pre-wrap leading-relaxed pl-4 border-l-2 border-emerald-500/30">${state.summaries.summary_final}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFinalReport() {
            const htmlContent = marked.parse(state.diagnosis);
            return `
                <div class="fade-in pb-24">
                    <!-- Sticky Action Bar -->
                    <div class="sticky top-24 z-30 flex justify-between items-center bg-white/80 backdrop-blur-xl p-4 rounded-2xl shadow-sm border border-slate-200/60 mb-8">
                        <div class="flex items-center gap-3 pl-2">
                            <div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center">
                                <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h2 class="text-lg font-bold text-slate-900 leading-none">Diagnosis Complete</h2>
                                <p class="text-xs text-slate-500 font-medium mt-1">Verified by Agentic Workflow</p>
                            </div>
                        </div>
                        <button onclick="state.step=2; updateView()" class="text-sm font-medium text-slate-600 hover:text-blue-600 bg-white border border-slate-200 px-4 py-2 rounded-lg hover:border-blue-300 transition-all shadow-sm hover:shadow">
                            New Analysis
                        </button>
                    </div>

                    <div class="grid lg:grid-cols-12 gap-8 items-start">
                        <!-- Report -->
                        <div class="lg:col-span-8 space-y-6">
                            <div class="bg-white rounded-2xl border border-slate-200 shadow-lg overflow-hidden">
                                <div class="h-1.5 bg-gradient-to-r from-blue-600 to-emerald-500 w-full"></div>
                                <div class="p-8 md:p-12">
                                    <div class="prose prose-slate max-w-none prose-headings:font-bold prose-h2:text-slate-800 prose-a:text-blue-600">
                                        ${htmlContent}
                                    </div>
                                </div>
                                <div class="bg-slate-50 px-8 py-4 border-t border-slate-100 flex justify-between items-center text-xs text-slate-400">
                                    <span>Generated by MediMind RAG</span>
                                    <span class="font-mono">ID: ${Date.now().toString().slice(-6)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar Context -->
                        <div class="lg:col-span-4 lg:sticky lg:top-44 space-y-6">
                            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col max-h-[80vh]">
                                <div class="px-5 py-4 border-b border-slate-100 bg-slate-50 flex items-center gap-2">
                                    <i data-lucide="file-text" class="w-4 h-4 text-slate-400"></i>
                                    <h3 class="font-semibold text-slate-700 text-sm uppercase tracking-wide">Clinical Context</h3>
                                </div>
                                <div class="p-5 overflow-y-auto bg-slate-50/50 text-xs text-slate-600 font-mono whitespace-pre-wrap leading-relaxed break-words border-l-2 border-slate-200">
                                    ${state.summaries.summary_final}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Core Loop ---
        function updateView() {
            const root = document.getElementById('app-root');
            if (state.isLoading) {
                // Overlay handling logic
                if (!document.getElementById('loading-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.id = 'loading-overlay';
                    overlay.innerHTML = renderLoading();
                    root.style.position = 'relative';
                    root.appendChild(overlay.firstElementChild);
                }
            } else {
                if (state.step === 1) root.innerHTML = renderUpload();
                else if (state.step === 2) root.innerHTML = renderReview();
                else if (state.step === 4) root.innerHTML = renderSummaryView();
                else if (state.step === 6) root.innerHTML = renderFinalReport();
            }
            lucide.createIcons();
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) uploadFile(input.files[0]);
        }

        checkServer();
        updateView();
        setInterval(checkServer, 5000);
    </script>
</body>
</html>